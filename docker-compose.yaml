# Docker Compose for Coolify Deployment
# Coolify will automatically detect and use this file

services:
  # API Application
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ${COOLIFY_CONTAINER_NAME:-vmp-api}
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=${PORT:-3000}
      - MONGO_URI=${MONGO_URI:-mongodb://admin:0814940664asdUZ@@vmp-mongo:27017/vmp_production}
      - REDIS_HOST=${REDIS_HOST:-vmp-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-0814940664asdUZ@}
      - JWT_SECRET=${JWT_SECRET:-change-me}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN:-7d}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - API_PREFIX=${API_PREFIX:-api/v1}
      - SWAGGER_ENABLED=${SWAGGER_ENABLED:-true}
      - SWAGGER_PATH=${SWAGGER_PATH:-docs}
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-true}
      - RATE_LIMIT_TTL=${RATE_LIMIT_TTL:-60}
      - RATE_LIMIT_MAX=${RATE_LIMIT_MAX:-100}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    depends_on:
      mongo:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - vmp-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # MongoDB Database
  mongo:
    image: mongo:7
    container_name: vmp-mongo
    restart: unless-stopped
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=0814940664asdUZ@
      - MONGO_INITDB_DATABASE=vmp_production
    volumes:
      - mongo-data:/data/db
      - mongo-config:/data/configdb
    networks:
      - vmp-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command: ["--auth"]

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: vmp-redis
    restart: unless-stopped
    command: redis-server --requirepass 0814940664asdUZ@ --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - vmp-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "0814940664asdUZ@", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

networks:
  vmp-network:
    driver: bridge

volumes:
  mongo-data:
    driver: local
  mongo-config:
    driver: local
  redis-data:
    driver: local

